\begin{comment}
\begin{code}
{-# OPTIONS --without-K --rewriting --prop #-}

{-

  Experimenting with abstract logical connectives and a flat
  organization.

-}

{-
 Authors: Siek, Thiemann, and Wadler

 Based on "Logical Step-Indexed Logical Relations"
 by Dreyer, Ahmed, and Birkedal.

 Based on the Agda development of Logical Step-Indexed Logical Relations
 by Philip Wadler (June 1, 2022)

 The proof of the fixpoint theorem is based on "An Indexed Model of
 Recursive Types" by Appel and McAllester.

-}
module StepIndexedLogic2 where

open import Agda.Primitive using (lzero; lsuc)
open import Data.Empty using (‚ä•; ‚ä•-elim)
open import Data.List using (List; []; _‚à∑_)
open import Data.Nat
   using (‚Ñï; zero; suc; _+_; _‚à∏_) renaming (_<_ to _<‚Çô_)
open import Data.Product
   renaming (_,_ to _,·µÉ_; ‚àÉ to ‚àÉ·µÉ) using ()
open import Data.Unit using (tt; ‚ä§)
open import Data.Unit.Polymorphic renaming (‚ä§ to top·µñ; tt to tt·µñ)
import Relation.Binary.PropositionalEquality as Eq
open Eq using (_‚â°_; _‚â¢_; refl; sym; trans; cong; cong‚ÇÇ; cong-app; subst)
open import Relation.Nullary using (¬¨_)
open import Function using (id; _‚àò_)
open import Level using (Lift)

open import Agda.Builtin.Equality
open import Agda.Builtin.Equality.Rewrite

open import EquivalenceRelationProp public

open import PropP
open import StrongInduction
open import SILVariables public
open import Env public
open import RawSetO
open import Approx
open import Iteration
open import SetO public
open import Fixpoint
open import Membership
open import Later
open import RecPred
open import Conjunction
open import Disjunction
open import Implication
open import Forall
open import Exists
open import Pure
open import Let
\end{code}
\end{comment}

\begin{code}
record Set‚Å± : Set‚ÇÅ where
  field
    # : Set‚Çí
    down : downClosed #
    tz : # 0
open Set‚Å± public
  
abstract

 {---------------------- Membership in Recursive Predicate --------------------}

  _‚àà_ : ‚àÄ{Œì}{A} ‚Üí A ‚Üí (x : Œì ‚àã A) ‚Üí Set·µí Œì (var-now Œì x)
  a ‚àà x = record { # = (Œª Œ¥ ‚Üí (lookup x Œ¥) a) ; down = down-lookup ; wellformed = (wellformed-lookup x) ; congr = (congruent-lookup x a) }

  #‚àà‚â° : ‚àÄ{Œì}{A} ‚Üí (a : A) ‚Üí (x : Œì ‚àã A) ‚Üí # (a ‚àà x) ‚â° Œª Œ¥ ‚Üí (lookup x Œ¥) a
  #‚àà‚â° a x = refl
  
{---------------------- Later Operator ---------------------}

  ‚ñ∑·µí : ‚àÄ{Œì}{Œî : Times Œì}
     ‚Üí Set·µí Œì Œî
       -----------------
     ‚Üí Set·µí Œì (laters Œì)
  ‚ñ∑·µí {Œì}{Œî} S = record { # = (Œª Œ¥ ‚Üí ‚ñ∑ ((# S) Œ¥)) ; down = (down-later S) ; wellformed = (wellformed-‚ñ∑ S) ; congr =  (Œª Œ¥=Œ¥‚Ä≤ ‚Üí cong-‚ñ∑ (congr S Œ¥=Œ¥‚Ä≤)) }

  #‚ñ∑·µí‚â° : ‚àÄ{Œì}{Œî}{œï : Set·µí Œì Œî} ‚Üí # (‚ñ∑·µí œï) ‚â° Œª Œ¥ ‚Üí ‚ñ∑ (# œï Œ¥)
  #‚ñ∑·µí‚â° {Œì}{Œî}{œï} = let x = # (‚ñ∑·µí œï) in refl

  ‚ñ∑sk : ‚àÄ{Œì}{Œî}{œï : Set·µí Œì Œî}{Œ¥ : RecEnv Œì}{k}
     ‚Üí downClosed·µà Œ¥
     ‚Üí ‚ñ∑ (# œï Œ¥) (suc k) ‚áî # œï Œ¥ k
  ‚ñ∑sk {Œì}{Œî}{œï}{Œ¥}{k} down-Œ¥ =
     (Œª ‚ñ∑œïsk ‚Üí ‚ñ∑œïsk k (‚â§-refl‚Çö{k})) ,‚Çö Œª œïk j j<sk ‚Üí down œï Œ¥ down-Œ¥ k œïk j (‚â§-pred‚Çö{j}{k} j<sk)

{---------------------- Recursive Predicate -----------------------------------}

abstract
  Œº·µí : ‚àÄ{Œì}{Œî : Times Œì}{A}
     ‚Üí (A ‚Üí Set·µí (A ‚à∑ Œì) (Later ‚à∑ Œî))
     ‚Üí (A ‚Üí Set·µí Œì Œî)
  Œº·µí {Œì}{Œî}{A} S·µÉ a = record { # = (Œª Œ¥ ‚Üí mu S·µÉ Œ¥ a) ; down = (down-mu S·µÉ a) ; wellformed = (wellformed-mu S·µÉ a) ; congr = (congruent-mu S·µÉ a) }

  #Œº·µí‚â° : ‚àÄ{Œì}{Œî : Times Œì}{A} (S·µÉ : A ‚Üí Set·µí (A ‚à∑ Œì) (Later ‚à∑ Œî)) (a : A) ‚Üí ‚àÄ Œ¥ k
     ‚Üí # (Œº·µí S·µÉ a) Œ¥ k ‚â° mu S·µÉ Œ¥ a k
  #Œº·µí‚â° S·µÉ a Œ¥ k = refl

{---------------------- Forall -----------------------------------------}

  ‚àÄ·µí : ‚àÄ{Œì}{Œî : Times Œì}{A : Set}
     ‚Üí (A ‚Üí Set·µí Œì Œî)
     ‚Üí Set·µí Œì Œî
  ‚àÄ·µí{Œì}{Œî}{A} P = record { # = (Œª Œ¥ ‚Üí ‚àÄ‚Çí[ a ‚¶Ç A ] # (P a) Œ¥) ;
                           down = (Œª Œ¥ dc-Œ¥ n PŒ¥n k k‚â§n a ‚Üí down (P a) Œ¥ dc-Œ¥ n (PŒ¥n a) k k‚â§n) ;
                           wellformed = (wellformed-all P) ;
                           congr = (Œª Œ¥=Œ¥‚Ä≤ ‚Üí cong-‚àÄ Œª a ‚Üí congr (P a) Œ¥=Œ¥‚Ä≤) }

  #‚àÄ·µí‚â° : ‚àÄ{Œì}{Œî : Times Œì}{A : Set}{S·µÉ : A ‚Üí Set·µí Œì Œî}{Œ¥}{k}
     ‚Üí (# (‚àÄ·µí S·µÉ) Œ¥ k) ‚â° ‚àÄ (a : A) ‚Üí # (S·µÉ a) Œ¥ k
  #‚àÄ·µí‚â° = refl
  
{---------------------- Exists -----------------------------------------}

  ‚àÉ·µí : ‚àÄ{Œì}{Œî : Times Œì}{A : Set}
     ‚Üí (A ‚Üí Set·µí Œì Œî)
     ‚Üí Set·µí Œì Œî
  ‚àÉ·µí{Œì}{Œî}{A} P = record { # = (Œª Œ¥ ‚Üí ‚àÉ‚Çí[ a ‚¶Ç A ] # (P a) Œ¥) ;
                           down = (Œª Œ¥ dc-Œ¥ n a√óPaŒ¥n k k‚â§n ‚Üí match a√óPaŒ¥n Œª a Pa ‚Üí a ,‚Çö (down (P a) Œ¥ dc-Œ¥ n Pa k k‚â§n)) ;
                           wellformed = (wellformed-exists P) ;
                           congr = (Œª Œ¥=Œ¥‚Ä≤ ‚Üí cong-‚àÉ Œª a ‚Üí congr (P a) Œ¥=Œ¥‚Ä≤) }

  #‚àÉ·µí‚â° : ‚àÄ{Œì}{Œî : Times Œì}{A : Set}{S·µÉ : A ‚Üí Set·µí Œì Œî}{Œ¥}{k}
     ‚Üí (# (‚àÉ·µí S·µÉ) Œ¥ k) ‚â° (Œ£‚Çö[ a ‚àà A ] (# (S·µÉ a) Œ¥ k))
  #‚àÉ·µí‚â° = refl

  cong-‚àÉ·µí : ‚àÄ{Œì Œî}{A}{œï·µÉ œà·µÉ : A ‚Üí Set·µí Œì Œî} ‚Üí (‚àÄ a ‚Üí œï·µÉ a ‚â°·µí œà·µÉ a) ‚Üí ‚àÉ·µí œï·µÉ ‚â°·µí ‚àÉ·µí œà·µÉ 
  cong-‚àÉ·µí{Œì}{Œî} œï=œà = ‚áî‚áí‚â°·µí Œª Œ¥ k ‚Üí cong-‚àÉ (Œª a k‚ÇÅ ‚Üí let œïa=œàa = œï=œà a in ‚â°·µí‚áí‚áî{Œ¥ = Œ¥}{k = k} œïa=œàa) k

{---------------------- Pure (Set) ------------------------------------}

  _·µí : ‚àÄ{Œì} ‚Üí Set ‚Üí Set·µí Œì (laters Œì)
  p ·µí = record { # = (Œª Œ¥ ‚Üí p ‚Çí) ; down = (Œª Œ¥ dc-Œ¥ n p k k‚â§n ‚Üí p) ; wellformed = (wellformed-pure p) ;
                 congr = (Œª Œ¥=Œ¥‚Ä≤ ‚Üí ‚â°‚Çí-refl refl) }

  #pure·µí‚â° : ‚àÄ{p}{Œì}{Œ¥ : RecEnv Œì}{k} ‚Üí # (p ·µí) Œ¥ k ‚â° Squash p
  #pure·µí‚â° = refl

{---------------------- Pure (Prop) -----------------------------------}

  _·µñ : ‚àÄ{Œì} ‚Üí Prop ‚Üí Set·µí Œì (laters Œì)
  p ·µñ = record { # = (Œª Œ¥ ‚Üí p ‚Çö) ; down = (Œª Œ¥ dc-Œ¥ n p k k‚â§n ‚Üí p) ; wellformed = (wellformed-pure-prop p) ;
                 congr = (Œª Œ¥=Œ¥‚Ä≤ ‚Üí ‚â°‚Çí-refl refl) }

  #pure·µñ‚â° : ‚àÄ{p}{Œì}{Œ¥ : RecEnv Œì}{k} ‚Üí # (p ·µñ) Œ¥ (suc k) ‚â° p
  #pure·µñ‚â° = refl

{---------------------- Indexed Set ------------------------------------}

  wellformed-indexed : ‚àÄ{Œì}{A}{Œî : Times Œì} (S : Set‚Å±) (x : Œì ‚àã A)
                     ‚Üí wellformed-var x (timeof x Œî) (Œª Œ¥ ‚Üí # S)
  wellformed-indexed {Œì}{A}{Œî} S x
      with timeof x Œî
  ... | Now = Œª Œ¥ j k k‚â§j ‚Üí ‚â°‚Çí-refl refl
  ... | Later = Œª Œ¥ j k k‚â§j ‚Üí ‚â°‚Çí-refl refl

  _‚Å± : ‚àÄ{Œì} ‚Üí Set‚Å± ‚Üí Set·µí Œì (laters Œì)
  S ‚Å± = record { # = (Œª Œ¥ ‚Üí # S) ;
                 down = (Œª Œ¥ dc-Œ¥ n Sn k k‚â§n ‚Üí down S n Sn k k‚â§n) ;
                 wellformed = wellformed-indexed S ;
                 congr = (Œª Œ¥=Œ¥‚Ä≤ ‚Üí ‚â°‚Çí-refl refl) }

  #indexed·µí‚â° : ‚àÄ{S}{Œì}{Œ¥ : RecEnv Œì}{k} ‚Üí # (S ‚Å±) Œ¥ k ‚â° # S k
  #indexed·µí‚â° = refl

{---------------------- False -----------------------------------------}

  ‚ä•·µí : ‚àÄ{Œì} ‚Üí Set·µí Œì (laters Œì)
  ‚ä•·µí = ‚ä• ·µí

  #‚ä•·µí‚â°‚ä• : ‚àÄ{Œì}{Œ¥ : RecEnv Œì}{k} ‚Üí # ‚ä•·µí Œ¥ k ‚â° Squash ‚ä•
  #‚ä•·µí‚â°‚ä• = refl

{---------------------- True -----------------------------------------}

  ‚ä§·µí : ‚àÄ{Œì} ‚Üí Set·µí Œì (laters Œì)
  ‚ä§·µí = ‚ä§ ·µí

  #‚ä§·µí‚â°‚ä§ : ‚àÄ{Œì}{Œ¥ : RecEnv Œì}{k} ‚Üí # ‚ä§·µí Œ¥ k ‚â° Squash ‚ä§
  #‚ä§·µí‚â°‚ä§ = refl

{---------------------- Conjunction -----------------------------------------}

  infixr 7 _√ó·µí_
  _√ó·µí_ : ‚àÄ{Œì}{Œî‚ÇÅ Œî‚ÇÇ : Times Œì}
     ‚Üí Set·µí Œì Œî‚ÇÅ
     ‚Üí Set·µí Œì Œî‚ÇÇ
       ------------------------
     ‚Üí Set·µí Œì (combine Œî‚ÇÅ Œî‚ÇÇ)
  S √ó·µí T = record { # = (Œª Œ¥ ‚Üí (# S Œ¥) √ó‚Çí (# T Œ¥)) ;
                    down = (Œª Œ¥ dc-Œ¥ n SŒ¥n√óTŒ¥n k k‚â§n ‚Üí
                       (down S Œ¥ dc-Œ¥ n (proj‚ÇÅ‚Çö SŒ¥n√óTŒ¥n) k k‚â§n)
                       ,‚Çö (down T Œ¥ dc-Œ¥ n (proj‚ÇÇ‚Çö SŒ¥n√óTŒ¥n) k k‚â§n)) ;
                    wellformed = (wellformed-conjunction S T) ;
                    congr =  (Œª Œ¥=Œ¥‚Ä≤ ‚Üí cong-√ó‚Çí (congr S Œ¥=Œ¥‚Ä≤) (congr T Œ¥=Œ¥‚Ä≤)) }

  #√ó·µí‚â° : ‚àÄ{Œì}{Œî‚ÇÅ Œî‚ÇÇ : Times Œì}{œï : Set·µí Œì Œî‚ÇÅ}{œà : Set·µí Œì Œî‚ÇÇ}{Œ¥}{k}
       ‚Üí (# (œï √ó·µí œà) Œ¥ k) ‚â° (# œï Œ¥ k √ó‚Çö # œà Œ¥ k)
  #√ó·µí‚â° {Œì}{Œî‚ÇÅ}{Œî‚ÇÇ}{œï}{œà}{Œ¥}{k} = refl

  cong-√ó·µí : ‚àÄ{Œì}{Œî}{œï œï‚Ä≤ œà œà‚Ä≤ : Set·µí Œì Œî} ‚Üí œï ‚â°·µí œï‚Ä≤ ‚Üí œà ‚â°·µí œà‚Ä≤ ‚Üí œï √ó·µí œà ‚â°·µí œï‚Ä≤ √ó·µí œà‚Ä≤
  cong-√ó·µí {Œì}{Œî}{œï}{œï‚Ä≤}{œà}{œà‚Ä≤} œï=œï‚Ä≤ œà=œà‚Ä≤ = ‚áî‚áí‚â°·µí (Œª Œ¥ k ‚Üí ‚áî-intro to fro)
    where
    to : ‚àÄ{Œ¥}{k} ‚Üí # (œï √ó·µí œà) Œ¥ k ‚Üí # (œï‚Ä≤ √ó·µí œà‚Ä≤) Œ¥ k
    to {Œ¥}{k} (œïk ,‚Çö œàk) = (‚áî-to (‚â°·µí‚áí‚áî œï=œï‚Ä≤) œïk) ,‚Çö (‚áî-to (‚â°·µí‚áí‚áî œà=œà‚Ä≤) œàk)
    fro  : ‚àÄ{k}{Œ¥} ‚Üí # (œï‚Ä≤ √ó·µí œà‚Ä≤) Œ¥ k ‚Üí #(œï √ó·µí œà) Œ¥ k
    fro {Œ¥}{k} (œï‚Ä≤k ,‚Çö œà‚Ä≤k) = (‚áî-fro (‚â°·µí‚áí‚áî œï=œï‚Ä≤) œï‚Ä≤k) ,‚Çö (‚áî-fro (‚â°·µí‚áí‚áî œà=œà‚Ä≤) œà‚Ä≤k)


{---------------------- Disjunction -----------------------------------------}

  infixr 7 _‚äé·µí_
  _‚äé·µí_ : ‚àÄ{Œì}{Œî‚ÇÅ Œî‚ÇÇ : Times Œì}
     ‚Üí Set·µí Œì Œî‚ÇÅ
     ‚Üí Set·µí Œì Œî‚ÇÇ
       ------------------------
     ‚Üí Set·µí Œì (combine Œî‚ÇÅ Œî‚ÇÇ)
  S ‚äé·µí T = record { # = (Œª Œ¥ ‚Üí (# S Œ¥) ‚äé‚Çí (# T Œ¥)) ;
                    down = (Œª {Œ¥ dc-Œ¥ n (inj‚ÇÅ‚Çö Sn) k k‚â§n ‚Üí inj‚ÇÅ‚Çö (down S Œ¥ dc-Œ¥ n Sn k k‚â§n);
                         Œ¥ dc-Œ¥ n (inj‚ÇÇ‚Çö Tn) k k‚â§n ‚Üí inj‚ÇÇ‚Çö (down T Œ¥ dc-Œ¥ n Tn k k‚â§n)}) ;
                    wellformed = (wellformed-disjunction S T) ;
                    congr = Œª Œ¥=Œ¥‚Ä≤ ‚Üí cong-‚äé‚Çí (congr S Œ¥=Œ¥‚Ä≤) (congr T Œ¥=Œ¥‚Ä≤) }

  #‚äé·µí‚â° : ‚àÄ{Œì}{Œî‚ÇÅ Œî‚ÇÇ : Times Œì}{œï : Set·µí Œì Œî‚ÇÅ}{œà : Set·µí Œì Œî‚ÇÇ}{Œ¥}{k}
       ‚Üí (# (œï ‚äé·µí œà) Œ¥ k) ‚â° (# œï Œ¥ k ‚äé‚Çö # œà Œ¥ k)
  #‚äé·µí‚â° {Œì}{Œî‚ÇÅ}{Œî‚ÇÇ}{œï}{œà}{Œ¥}{k} = refl

  cong-‚äé·µí : ‚àÄ{Œì}{Œî}{œï œï‚Ä≤ œà œà‚Ä≤ : Set·µí Œì Œî} ‚Üí œï ‚â°·µí œï‚Ä≤ ‚Üí œà ‚â°·µí œà‚Ä≤ ‚Üí œï ‚äé·µí œà ‚â°·µí œï‚Ä≤ ‚äé·µí œà‚Ä≤
  cong-‚äé·µí {Œì}{Œî}{œï}{œï‚Ä≤}{œà}{œà‚Ä≤} œï=œï‚Ä≤ œà=œà‚Ä≤ = ‚áî‚áí‚â°·µí (Œª Œ¥ k ‚Üí ‚áî-intro to fro)
    where
    to : ‚àÄ{Œ¥}{k} ‚Üí # (œï ‚äé·µí œà) Œ¥ k ‚Üí # (œï‚Ä≤ ‚äé·µí œà‚Ä≤) Œ¥ k
    to (inj‚ÇÅ‚Çö x) = inj‚ÇÅ‚Çö (proj‚ÇÅ‚Çö (‚â°·µí‚áí‚áî œï=œï‚Ä≤) x)
    to (inj‚ÇÇ‚Çö y) = inj‚ÇÇ‚Çö (proj‚ÇÅ‚Çö (‚â°·µí‚áí‚áî œà=œà‚Ä≤) y)
    fro  : ‚àÄ{Œ¥}{k} ‚Üí #(œï‚Ä≤ ‚äé·µí œà‚Ä≤) Œ¥ k ‚Üí #(œï ‚äé·µí œà) Œ¥ k
    fro (inj‚ÇÅ‚Çö x) = inj‚ÇÅ‚Çö (proj‚ÇÇ‚Çö (‚â°·µí‚áí‚áî œï=œï‚Ä≤) x)
    fro (inj‚ÇÇ‚Çö y) = inj‚ÇÇ‚Çö (proj‚ÇÇ‚Çö (‚â°·µí‚áí‚áî œà=œà‚Ä≤) y)

{---------------------- Implication -----------------------------------------}

  infixr 6 _‚Üí·µí_
  _‚Üí·µí_ : ‚àÄ{Œì}{Œî‚ÇÅ Œî‚ÇÇ : Times Œì}
     ‚Üí Set·µí Œì Œî‚ÇÅ
     ‚Üí Set·µí Œì Œî‚ÇÇ
       ------------------------
     ‚Üí Set·µí Œì (combine Œî‚ÇÅ Œî‚ÇÇ)
  S ‚Üí·µí T = record { # = (Œª Œ¥ ‚Üí (# S Œ¥) ‚Üí‚Çí (# T Œ¥)) ;
                    down = (Œª Œ¥ dc-Œ¥ n ‚àÄj<n,Sj‚ÜíTj k k‚â§n j j‚â§k Sj ‚Üí
                        ‚àÄj<n,Sj‚ÜíTj j (‚â§-trans‚Çö{j}{k}{n} j‚â§k k‚â§n) Sj) ;
                    wellformed = (wellformed-implication S T) ;
                    congr = (Œª Œ¥=Œ¥‚Ä≤ ‚Üí cong-‚Üí‚Çí (congr S Œ¥=Œ¥‚Ä≤) (congr T Œ¥=Œ¥‚Ä≤)) }
                     
  #‚Üí·µí‚â° : ‚àÄ{Œì}{Œî‚ÇÅ Œî‚ÇÇ : Times Œì}{œï : Set·µí Œì Œî‚ÇÅ}{œà : Set·µí Œì Œî‚ÇÇ}{Œ¥}{k}
       ‚Üí (# (œï ‚Üí·µí œà) Œ¥ k) ‚â° (‚àÄ j ‚Üí j ‚â§‚Çö k ‚Üí # œï Œ¥ j ‚Üí # œà Œ¥ j)
  #‚Üí·µí‚â° {Œì}{Œî‚ÇÅ}{Œî‚ÇÇ}{œï}{œà}{Œ¥}{k} = refl

{---------------------- Let for Predicates -----------------------------------------}

  let·µí : ‚àÄ{A}{Œì}{t}{Œî} ‚Üí (A ‚Üí Set·µí Œì Œî) ‚Üí Set·µí (A ‚à∑ Œì) (t ‚à∑ Œî) ‚Üí Set·µí Œì Œî   
  let·µí S·µÉ T = record { # =  (Œª Œ¥ ‚Üí  # T ((Œª a ‚Üí # (S·µÉ a) Œ¥) ,·µÉ Œ¥)) ;
                      down = (Œª Œ¥ dc-Œ¥ n Tn k k‚â§n ‚Üí
                              down T ((Œª a k ‚Üí # (S·µÉ a) Œ¥ k) ,·µÉ Œ¥)
                                     ((Œª a ‚Üí down (S·µÉ a) Œ¥ dc-Œ¥) ,‚Çö dc-Œ¥)
                                     n Tn k k‚â§n) ;
                      wellformed = (wellformed-let T S·µÉ) ;
                      congr = Œª Œ¥=Œ¥‚Ä≤ ‚Üí congr T ((Œª a ‚Üí congr (S·µÉ a) Œ¥=Œ¥‚Ä≤) ,‚Çö Œ¥=Œ¥‚Ä≤) }
                        
  #let·µí‚â° : ‚àÄ{A}{Œì}{Œî}{t} (P : A ‚Üí Set·µí Œì Œî) (œï : Set·µí (A ‚à∑ Œì) (t ‚à∑ Œî)) ‚Üí ‚àÄ Œ¥ k
     ‚Üí (# (let·µí P œï) Œ¥ k) ‚â° (# œï ((Œª a k ‚Üí # (P a) Œ¥ k) ,·µÉ Œ¥) k)
  #let·µí‚â° {A}{Œì}{Œî}{t} P œï d k = refl
  
  let-‚ñ∑·µí : ‚àÄ{A}{t}{P : A ‚Üí Set·µí [] []}{œï : Set·µí (A ‚à∑ []) (t ‚à∑ [])}
     ‚Üí let·µí P (‚ñ∑·µí œï) ‚â° ‚ñ∑·µí (let·µí P œï)
  let-‚ñ∑·µí {A} {t} {P} {œï} = refl
  
  let-‚àà : ‚àÄ{A}{P : A ‚Üí Set·µí [] []}{a : A}
     ‚Üí let·µí P (a ‚àà zero·µí) ‚â° (P a)
  let-‚àà {A}{P}{a} = refl
  
  let-pure·µí : ‚àÄ{A : Set}{P : A ‚Üí Set·µí [] []}{p : Set}
     ‚Üí let·µí P (p ·µí) ‚â° p ·µí
  let-pure·µí = refl

  let-pure·µñ : ‚àÄ{A : Set}{P : A ‚Üí Set·µí [] []}{p : Prop}
     ‚Üí let·µí P (p ·µñ) ‚â° p ·µñ
  let-pure·µñ = refl

  let-‚ä•·µí : ‚àÄ{A}{P : A ‚Üí Set·µí [] []}
     ‚Üí let·µí P ‚ä•·µí ‚â° ‚ä•·µí
  let-‚ä•·µí = refl

  let-‚ä§·µí : ‚àÄ{A}{P : A ‚Üí Set·µí [] []}
     ‚Üí let·µí P ‚ä§·µí ‚â° ‚ä§·µí
  let-‚ä§·µí = refl

  let-√ó·µí : ‚àÄ{A}{P : A ‚Üí Set·µí [] []}{œï œà : Set·µí (A ‚à∑ []) (Later ‚à∑ [])}
     ‚Üí let·µí P (œï √ó·µí œà) ‚â° (let·µí P œï) √ó·µí (let·µí P œà)
  let-√ó·µí = refl

  let-‚äé·µí : ‚àÄ{A}{P : A ‚Üí Set·µí [] []}{œï œà : Set·µí (A ‚à∑ []) (Later ‚à∑ [])}
     ‚Üí let·µí P (œï ‚äé·µí œà) ‚â° (let·µí P œï) ‚äé·µí (let·µí P œà)
  let-‚äé·µí = refl

  let-‚Üí·µí : ‚àÄ{A}{P : A ‚Üí Set·µí [] []}{œï œà : Set·µí (A ‚à∑ []) (Later ‚à∑ [])}
     ‚Üí let·µí P (œï ‚Üí·µí œà) ‚â° (let·µí P œï) ‚Üí·µí (let·µí P œà)
  let-‚Üí·µí = refl

  let-‚àÄ·µí : ‚àÄ{A}{B}{P : A ‚Üí Set·µí [] []}{œï·µá  : B ‚Üí Set·µí (A ‚à∑ []) (Later ‚à∑ [])}
     ‚Üí let·µí P (‚àÄ·µí œï·µá) ‚â° ‚àÄ·µí Œª b ‚Üí  (let·µí P (œï·µá b))
  let-‚àÄ·µí {A}{B}{P}{œï·µá} = refl

  let-‚àÉ·µí : ‚àÄ{A}{B}{P : A ‚Üí Set·µí [] []}{œï·µá  : B ‚Üí Set·µí (A ‚à∑ []) (Later ‚à∑ [])}
     ‚Üí let·µí P (‚àÉ·µí œï·µá) ‚â° ‚àÉ·µí Œª b ‚Üí  (let·µí P (œï·µá b))
  let-‚àÉ·µí {A}{B}{P}{œï·µá} = refl

{-# REWRITE let-‚ä•·µí #-}
{-# REWRITE let-‚ä§·µí #-}
{-# REWRITE let-‚ñ∑·µí #-}
{-# REWRITE let-‚àà #-}
{-# REWRITE let-pure·µí #-}
{-# REWRITE let-pure·µñ #-}
{-# REWRITE let-√ó·µí #-}
{-# REWRITE let-‚äé·µí #-}
{-# REWRITE let-‚Üí·µí #-}
{-# REWRITE let-‚àÄ·µí #-}
{-# REWRITE let-‚àÉ·µí #-}

{---------------------- Fixpoint Theorem --------------------------------------}

Set·µè : Set‚ÇÅ
Set·µè = Set·µí [] []

private variable œï œï‚Ä≤ œà œà‚Ä≤ √æ œÉ : Set·µè
private variable ùí´ : List Set·µè
private variable p : Set
private variable A B C : Set
private variable Œì : Context
private variable Œî Œî‚ÇÅ Œî‚ÇÇ : Times Œì

abstract
  fixpoint·µí : ‚àÄ{Œì}{Œî : Times Œì}{A} (S·µÉ : A ‚Üí Set·µí (A ‚à∑ Œì) (Later ‚à∑ Œî)) (a : A)
     ‚Üí (Œº·µí S·µÉ) a ‚â°·µí let·µí (Œº·µí S·µÉ) (S·µÉ a)
  fixpoint·µí{Œì}{Œî}{A} S·µÉ a = ‚â°‚Çí‚áí‚â°·µí{Œì}{Œî} aux
    where
    aux : ‚àÄ Œ¥ ‚Üí # (Œº·µí S·µÉ a) Œ¥ ‚â°‚Çí # (let·µí (Œº·µí S·µÉ) (S·µÉ a)) Œ¥
    aux Œ¥ =
        # (Œº·µí S·µÉ a) Œ¥ 
      ‚©¶‚ü® ‚â°‚Çí-refl refl ‚ü©
        mu S·µÉ Œ¥ a
      ‚©¶‚ü® equiv-approx (lemma19a S·µÉ a Œ¥) ‚ü©
        # (S·µÉ a) ((Œª a k ‚Üí mu S·µÉ Œ¥ a k) ,·µÉ Œ¥) 
      ‚©¶‚ü® ‚â°‚Çí-refl refl ‚ü©
        # (S·µÉ a) ((Œª a k ‚Üí # (Œº·µí S·µÉ a) Œ¥ k) ,·µÉ Œ¥)
      ‚©¶‚ü® ‚â°‚Çí-refl refl ‚ü©
        # (let·µí (Œº·µí S·µÉ) (S·µÉ a)) Œ¥
      ‚àé

{---------------------- Proof Theory for Step Indexed Logic -------------------}

Œ†·µè : List Set·µè ‚Üí Set·µè
Œ†·µè [] = ‚ä§·µí
Œ†·µè (P ‚à∑ ùí´) = P √ó·µí Œ†·µè ùí´ 

abstract
  infix 1 _‚ä¢·µí_
  _‚ä¢·µí_ : List Set·µè ‚Üí Set·µè ‚Üí Prop  -- try changing to Set
  ùí´ ‚ä¢·µí P = ‚àÄ n ‚Üí # (Œ†·µè ùí´) tt·µñ n ‚Üí # P tt·µñ n

  ‚ä¢·µíI : ‚àÄ{ùí´}{P}
     ‚Üí (‚àÄ n ‚Üí # (Œ†·µè ùí´) tt·µñ n ‚Üí # P tt·µñ n)
     ‚Üí ùí´ ‚ä¢·µí P
  ‚ä¢·µíI ùí´‚ÜíP = ùí´‚ÜíP

  ‚ä¢·µíE : ‚àÄ{ùí´}{P}
     ‚Üí ùí´ ‚ä¢·µí P
     ‚Üí (‚àÄ n ‚Üí # (Œ†·µè ùí´) tt·µñ n ‚Üí # P tt·µñ n)
  ‚ä¢·µíE ùí´‚ä¢P = ùí´‚ä¢P

abstract
  tt·µí : ùí´ ‚ä¢·µí ‚ä§·µí
  tt·µí n _ = squash tt

abstract
  ‚ä•-elim·µí : ùí´ ‚ä¢·µí ‚ä•·µí ‚Üí (œï : Set·µè) ‚Üí ùí´ ‚ä¢·µí œï
  ‚ä•-elim·µí ‚ä¢‚ä• œï n ‚ä®ùí´sn 
      with ‚ä¢‚ä• n ‚ä®ùí´sn
  ... | squash ()

  ‚ä•‚áí‚ä•·µí : ‚ä• ‚Üí ùí´ ‚ä¢·µí ‚ä•·µí
  ‚ä•‚áí‚ä•·µí ()

  ‚ä•·µí‚áí‚ä• : [] ‚ä¢·µí ‚ä•·µí ‚Üí ‚ä•‚Çö{lzero}
  ‚ä•·µí‚áí‚ä• ‚ä¢‚ä• 
      with ‚ä¢‚ä• 0 (squash tt)
  ... | squash ()
  
abstract
  pure·µíI : ‚àÄ{p : Set} ‚Üí p ‚Üí ùí´ ‚ä¢·µí p ·µí
  pure·µíI s n ‚ä®ùí´n = squash s

  pure·µíE : ùí´ ‚ä¢·µí p ·µí  ‚Üí  (p ‚Üí ùí´ ‚ä¢·µí √æ)  ‚Üí  ùí´ ‚ä¢·µí √æ
  pure·µíE {ùí´} {p} {R} ‚ä¢p p‚Üí‚ä¢R n ùí´n 
     with ‚ä¢p n ùí´n
  ... | squash r = p‚Üí‚ä¢R r n ùí´n

  pure·µíE[] : [] ‚ä¢·µí p ·µí  ‚Üí  Squash p
  pure·µíE[] ‚ä¢p·µí = ‚ä¢p·µí 0 (squash tt)

  pure·µñI : ‚àÄ{p : Prop} ‚Üí p ‚Üí ùí´ ‚ä¢·µí p ·µñ
  pure·µñI s n ‚ä®ùí´n = s

  pure·µñE : ‚àÄ{p : Prop} ‚Üí ùí´ ‚ä¢·µí p ·µñ  ‚Üí  (p ‚Üí ùí´ ‚ä¢·µí √æ)  ‚Üí  ùí´ ‚ä¢·µí √æ
  pure·µñE {ùí´} {p} {R} ‚ä¢p p‚Üí‚ä¢R n ùí´n 
     with ‚ä¢p n ùí´n
  ... | r = p‚Üí‚ä¢R r n ùí´n

  pure·µñE[] : ‚àÄ{p : Prop} ‚Üí [] ‚ä¢·µí p ·µñ  ‚Üí p
  pure·µñE[] ‚ä¢p·µñ = ‚ä¢p·µñ 0 (squash tt)

{-
pure·µíE-syntax = pure·µíE
infix 1 pure·µíE-syntax
syntax pure·µíE-syntax p·µí (Œª p ‚Üí ‚ä¢√æ) = let-pure·µí[ p ] p·µí within ‚ä¢√æ
-}

abstract
  _,·µí_ : ùí´ ‚ä¢·µí œï  ‚Üí  ùí´ ‚ä¢·µí œà  ‚Üí  ùí´ ‚ä¢·µí œï √ó·µí œà
  (ùí´‚ä¢œï ,·µí ùí´‚ä¢œà) n ‚ä®ùí´n = ùí´‚ä¢œï n ‚ä®ùí´n ,‚Çö ùí´‚ä¢œà n ‚ä®ùí´n

  proj‚ÇÅ·µí : ‚àÄ{ùí´ : List Set·µè }{P Q : Set·µè}
    ‚Üí ùí´ ‚ä¢·µí P √ó·µí Q
      ------------
    ‚Üí ùí´ ‚ä¢·µí P
  proj‚ÇÅ·µí ùí´‚ä¢P√óQ n ‚ä®ùí´n = proj‚ÇÅ‚Çö (ùí´‚ä¢P√óQ n ‚ä®ùí´n)

  proj‚ÇÇ·µí : ùí´ ‚ä¢·µí œï √ó·µí œà  ‚Üí  ùí´ ‚ä¢·µí œà
  proj‚ÇÇ·µí ùí´‚ä¢œï√óœà n ‚ä®ùí´n = proj‚ÇÇ‚Çö (ùí´‚ä¢œï√óœà n ‚ä®ùí´n)

abstract
  inj‚ÇÅ·µí : ùí´ ‚ä¢·µí œï ‚Üí ùí´ ‚ä¢·µí œï ‚äé·µí œà
  inj‚ÇÅ·µí ùí´‚ä¢œï n ‚ä®ùí´n = inj‚ÇÅ‚Çö (ùí´‚ä¢œï n ‚ä®ùí´n)

  inj‚ÇÇ·µí : ùí´ ‚ä¢·µí œà ‚Üí ùí´ ‚ä¢·µí œï ‚äé·µí œà
  inj‚ÇÇ·µí ùí´‚ä¢œà n ‚ä®ùí´n = inj‚ÇÇ‚Çö (ùí´‚ä¢œà n ‚ä®ùí´n)

  case·µí : ùí´ ‚ä¢·µí œï ‚äé·µí œà  ‚Üí  œï ‚à∑ ùí´ ‚ä¢·µí √æ  ‚Üí  œà ‚à∑ ùí´ ‚ä¢·µí √æ  ‚Üí  ùí´ ‚ä¢·µí √æ
  case·µí ùí´‚ä¢œï‚äéœà œï‚à∑ùí´‚ä¢√æ œà‚à∑ùí´‚ä¢√æ n ‚ä®ùí´n
      with ùí´‚ä¢œï‚äéœà n ‚ä®ùí´n
  ... | inj‚ÇÅ‚Çö œïn = œï‚à∑ùí´‚ä¢√æ n (œïn ,‚Çö ‚ä®ùí´n)
  ... | inj‚ÇÇ‚Çö œàn = œà‚à∑ùí´‚ä¢√æ n (œàn ,‚Çö ‚ä®ùí´n)

  case3·µí : ùí´ ‚ä¢·µí œï ‚äé·µí œà ‚äé·µí √æ  ‚Üí  œï ‚à∑ ùí´ ‚ä¢·µí œÉ  ‚Üí  œà ‚à∑ ùí´ ‚ä¢·µí œÉ  ‚Üí  √æ ‚à∑ ùí´ ‚ä¢·µí œÉ ‚Üí  ùí´ ‚ä¢·µí œÉ
  case3·µí ùí´‚ä¢œï‚äéœà‚äé√æ œï‚à∑ùí´‚ä¢œÉ œà‚à∑ùí´‚ä¢œÉ √æ‚à∑ùí´‚ä¢œÉ n ‚ä®ùí´n
      with ùí´‚ä¢œï‚äéœà‚äé√æ n ‚ä®ùí´n
  ... | inj‚ÇÅ‚Çö œïn = œï‚à∑ùí´‚ä¢œÉ n (œïn ,‚Çö ‚ä®ùí´n)
  ... | inj‚ÇÇ‚Çö (inj‚ÇÅ‚Çö œàn) = œà‚à∑ùí´‚ä¢œÉ n (œàn ,‚Çö ‚ä®ùí´n)
  ... | inj‚ÇÇ‚Çö (inj‚ÇÇ‚Çö √æn) = √æ‚à∑ùí´‚ä¢œÉ n (√æn ,‚Çö ‚ä®ùí´n)

abstract
  downClosed-Œ†·µè : (ùí´ : List Set·µè) ‚Üí downClosed (# (Œ†·µè ùí´) tt·µñ)
  downClosed-Œ†·µè [] = Œª n _ k _ ‚Üí (squash tt)
  downClosed-Œ†·µè (œï ‚à∑ ùí´) n (œïn ,‚Çö ‚ä®ùí´n) k k‚â§n =
    down œï tt·µñ tt‚Çö n œïn k k‚â§n ,‚Çö (downClosed-Œ†·µè ùí´ n ‚ä®ùí´n k k‚â§n)

abstract
  ‚Üí·µíI : œï ‚à∑ ùí´ ‚ä¢·µí œà  ‚Üí  ùí´ ‚ä¢·µí œï ‚Üí·µí œà
  ‚Üí·µíI {ùí´ = ùí´} œï‚à∑ùí´‚ä¢œà n ‚ä®ùí´n j j‚â§n œïj = œï‚à∑ùí´‚ä¢œà j (œïj ,‚Çö downClosed-Œ†·µè ùí´ n ‚ä®ùí´n j j‚â§n)

  ‚Üí·µíE : ùí´ ‚ä¢·µí œï ‚Üí·µí œà  ‚Üí  ùí´ ‚ä¢·µí œï  ‚Üí  ùí´ ‚ä¢·µí œà
  ‚Üí·µíE {ùí´} ùí´‚ä¢œï‚Üíœà ùí´‚ä¢œï n ‚ä®ùí´n = let œïn = ùí´‚ä¢œï n ‚ä®ùí´n in ùí´‚ä¢œï‚Üíœà n ‚ä®ùí´n n (‚â§-refl‚Çö{n}) œïn

abstract
  mono·µí : ùí´ ‚ä¢·µí œï  ‚Üí  ùí´ ‚ä¢·µí  ‚ñ∑·µí œï
  mono·µí {ùí´} ‚ä¢œï k ‚ä®ùí´k j j<k =
        ‚ä¢œï j (downClosed-Œ†·µè ùí´ k ‚ä®ùí´k j (‚â§-trans‚Çö{j}{suc j}{k} (n‚â§1+n‚Çö j) j<k)) 

abstract
  lob·µí : (‚ñ∑·µí œï) ‚à∑ ùí´ ‚ä¢·µí œï  ‚Üí  ùí´ ‚ä¢·µí œï
  lob·µí {œï}{ùí´} step k ‚ä®ùí´k = aux k step ‚ä®ùí´k
    where
    aux : ‚àÄ k ‚Üí ‚ñ∑·µí œï ‚à∑ ùí´ ‚ä¢·µí œï ‚Üí # (Œ†·µè ùí´) tt·µñ k ‚Üí # œï tt·µñ k
    aux = strong-induction si
     where
      si : ‚àÄ n ‚Üí (‚àÄ i ‚Üí i <‚Çö n ‚Üí ‚ñ∑·µí œï ‚à∑ ùí´ ‚ä¢·µí œï ‚Üí # (Œ†·µè ùí´) tt·µñ i ‚Üí # œï tt·µñ i)
         ‚Üí  ‚ñ∑·µí œï ‚à∑ ùí´ ‚ä¢·µí œï  ‚Üí  # (Œ†·µè ùí´) tt·µñ n ‚Üí # œï tt·µñ n
      si n IH step Pn =
        let ‚ä®ùí´n = downClosed-Œ†·µè ùí´ n Pn n (‚â§-refl‚Çö{n}) in
        step n ((Œª j j<sucn ‚Üí IH j j<sucn step (downClosed-Œ†·µè ùí´ n Pn j (‚â§-trans‚Çö{j}{suc j}{n} (n‚â§1+n‚Çö j) j<sucn))) ,‚Çö Pn)

abstract
  subst·µí : œï ‚â°·µí œà  ‚Üí  ùí´ ‚ä¢·µí œï  ‚Üí  ùí´ ‚ä¢·µí œà
  subst·µí œï=œà ùí´‚ä¢œï n ‚ä®ùí´n = ‚áî-to ((‚â°·µí‚áí‚â°‚Çí œï=œà) n) (ùí´‚ä¢œï n ‚ä®ùí´n)

abstract
  iff·µí : ([] ‚ä¢·µí œï  ‚Üí·µí œà) ‚Üí ([] ‚ä¢·µí œà  ‚Üí·µí œï) ‚Üí œï ‚â°·µí œà
  iff·µí œï‚Üíœà œà‚Üíœï = ‚áî‚áí‚â°·µí Œª Œ¥ k ‚Üí
         (Œª œïk ‚Üí œï‚Üíœà k (squash tt) k (‚â§-refl‚Çö {k}) œïk)
      ,‚Çö (Œª œàk ‚Üí œà‚Üíœï k (squash tt) k (‚â§-refl‚Çö {k}) œàk)

abstract
  Œõ·µí : {œï·µÉ : A ‚Üí Set·µè} ‚Üí (‚àÄ a ‚Üí ùí´ ‚ä¢·µí œï·µÉ a)  ‚Üí  ùí´ ‚ä¢·µí ‚àÄ·µí œï·µÉ
  Œõ·µí ‚àÄœï·µÉa n ‚ä®ùí´n a = ‚àÄœï·µÉa a n ‚ä®ùí´n

Œõ·µí-syntax = Œõ·µí
infix 1 Œõ·µí-syntax
syntax Œõ·µí-syntax (Œª a ‚Üí ‚ä¢œï·µÉa) = Œõ·µí[ a ] ‚ä¢œï·µÉa

abstract
  ‚àÄ·µíE : ‚àÄ{œï·µÉ : A ‚Üí Set·µè} ‚Üí ùí´ ‚ä¢·µí ‚àÄ·µí œï·µÉ  ‚Üí  (a : A)  ‚Üí  ùí´ ‚ä¢·µí œï·µÉ a
  ‚àÄ·µíE ‚ä¢‚àÄœï·µÉ a n ‚ä®ùí´n = ‚ä¢‚àÄœï·µÉ n ‚ä®ùí´n a

  ‚àÉ·µíI : ‚àÄ{œï·µÉ : A ‚Üí Set·µè} ‚Üí (a : A)  ‚Üí  ùí´ ‚ä¢·µí œï·µÉ a  ‚Üí  ùí´ ‚ä¢·µí ‚àÉ·µí œï·µÉ
  ‚àÉ·µíI a ‚ä¢œï·µÉa n ‚ä®ùí´n = a ,‚Çö (‚ä¢œï·µÉa n ‚ä®ùí´n)

  ‚àÉ·µíE : ‚àÄ{œï·µÉ : A ‚Üí Set·µè}{√æ : Set·µè}
     ‚Üí ùí´ ‚ä¢·µí ‚àÉ·µí œï·µÉ  ‚Üí  (‚àÄ a ‚Üí œï·µÉ a ‚à∑ ùí´ ‚ä¢·µí √æ)  ‚Üí  ùí´ ‚ä¢·µí √æ
  ‚àÉ·µíE ‚ä¢‚àÉœï·µÉ cont n ‚ä®ùí´n
      with ‚ä¢‚àÉœï·µÉ n ‚ä®ùí´n
  ... | (a ,‚Çö œï·µÉasn) = cont a n (œï·µÉasn ,‚Çö ‚ä®ùí´n)

abstract
  Z·µí : œï ‚à∑ ùí´ ‚ä¢·µí œï
  Z·µí n (œïn ,‚Çö ‚ä®ùí´n) = œïn

abstract
  S·µí : ùí´ ‚ä¢·µí œà  ‚Üí  œï ‚à∑ ùí´ ‚ä¢·µí œà
  S·µí ùí´‚ä¢œà n (œïn ,‚Çö ‚ä®ùí´n) = ùí´‚ä¢œà n ‚ä®ùí´n


Œª·µí : ‚àÄ œï ‚Üí (œï ‚à∑ ùí´ ‚ä¢·µí œï ‚Üí œï ‚à∑ ùí´ ‚ä¢·µí œà) ‚Üí ùí´ ‚ä¢·µí œï ‚Üí·µí œà
Œª·µí œï f = ‚Üí·µíI{œï = œï} (f Z·µí)

Œª·µí-syntax : ‚àÄ œï ‚Üí (œï ‚à∑ ùí´ ‚ä¢·µí œï ‚Üí œï ‚à∑ ùí´ ‚ä¢·µí œà) ‚Üí ùí´ ‚ä¢·µí œï ‚Üí·µí œà
Œª·µí-syntax = Œª·µí
infix 1 Œª·µí-syntax
syntax Œª·µí-syntax œï (Œª ‚ä¢œï ‚Üí ‚ä¢œà) = Œª·µí[ ‚ä¢œï ‚¶Ç œï ] ‚ä¢œà

unpack·µí : ‚àÄ{œï·µÉ : A ‚Üí Set·µè}{√æ : Set·µè}
     ‚Üí ùí´ ‚ä¢·µí ‚àÉ·µí œï·µÉ  ‚Üí  (‚àÄ a ‚Üí œï·µÉ a ‚à∑ ùí´ ‚ä¢·µí œï·µÉ a ‚Üí œï·µÉ a ‚à∑ ùí´ ‚ä¢·µí √æ)  ‚Üí  ùí´ ‚ä¢·µí √æ
unpack·µí ‚àÉœï cont = ‚àÉ·µíE ‚àÉœï Œª a ‚Üí cont a Z·µí

fold·µí : ‚àÄ{ùí´} (S·µÉ : A ‚Üí Set·µí (A ‚à∑ []) (Later ‚à∑ [])) (a : A) ‚Üí  ùí´ ‚ä¢·µí let·µí (Œº·µí S·µÉ) (S·µÉ a)  ‚Üí  ùí´ ‚ä¢·µí Œº·µí S·µÉ a
fold·µí S·µÉ a S·µÉ[ŒºS·µÉ] = subst·µí (‚â°·µí-sym (fixpoint·µí S·µÉ a)) S·µÉ[ŒºS·µÉ]

unfold·µí : ‚àÄ{ùí´} (S·µÉ : A ‚Üí Set·µí (A ‚à∑ []) (Later ‚à∑ [])) (a : A) ‚Üí  ùí´ ‚ä¢·µí Œº·µí S·µÉ a  ‚Üí  ùí´ ‚ä¢·µí let·µí (Œº·µí S·µÉ) (S·µÉ a)
unfold·µí S·µÉ a ŒºS·µÉ = subst·µí (fixpoint·µí S·µÉ a) ŒºS·µÉ

abstract
  ‚ñ∑√ó : ùí´ ‚ä¢·µí (‚ñ∑·µí (œï √ó·µí œà))  ‚Üí  ùí´ ‚ä¢·µí (‚ñ∑·µí œï) √ó·µí (‚ñ∑·µí œà)
  ‚ñ∑√ó ‚ñ∑œï√óœà n ùí´n = (Œª j j<n ‚Üí proj‚ÇÅ‚Çö (‚ñ∑œï√óœà n ùí´n j j<n))
                ,‚Çö (Œª j j<n ‚Üí proj‚ÇÇ‚Çö (‚ñ∑œï√óœà n ùí´n j j<n))

  
  ‚ñ∑‚äé : ùí´ ‚ä¢·µí (‚ñ∑·µí (œï ‚äé·µí œà))  ‚Üí  ùí´ ‚ä¢·µí (‚ñ∑·µí œï) ‚äé·µí (‚ñ∑·µí œà)
  ‚ñ∑‚äé ‚ñ∑œï‚äéœà zero ùí´n = inj‚ÇÅ‚Çö Œª j ()
  ‚ñ∑‚äé {ùí´}{œï}{œà} ‚ñ∑œï‚äéœà (suc n) ùí´n 
      with ‚ñ∑œï‚äéœà (suc n) ùí´n n (‚â§-refl‚Çö{n})
  ... | inj‚ÇÅ‚Çö œïn = inj‚ÇÅ‚Çö Œª { j j‚â§n ‚Üí down œï tt·µñ tt‚Çö n œïn j j‚â§n }
  ... | inj‚ÇÇ‚Çö œàn = inj‚ÇÇ‚Çö Œª { j j‚â§n ‚Üí down œà tt·µñ tt‚Çö n œàn j j‚â§n }


  ‚ñ∑‚Üí : ùí´ ‚ä¢·µí (‚ñ∑·µí (œï ‚Üí·µí œà))  ‚Üí  ùí´ ‚ä¢·µí (‚ñ∑·µí œï) ‚Üí·µí (‚ñ∑·µí œà)
  ‚ñ∑‚Üí ‚ñ∑œï‚Üíœà n ‚ä®ùí´n i i‚â§n ‚ñ∑œïi j j<si = 
     let œïj‚Üíœàj = ‚ñ∑œï‚Üíœà n ‚ä®ùí´n j (‚â§-trans‚Çö{suc j}{i}{n} j<si i‚â§n) j (‚â§-refl‚Çö{j}) in
     œïj‚Üíœàj (‚ñ∑œïi j j<si)

  ‚Üí‚ñ∑ : ùí´ ‚ä¢·µí (‚ñ∑·µí œï) ‚Üí·µí (‚ñ∑·µí œà) ‚Üí ùí´ ‚ä¢·µí (‚ñ∑·µí (œï ‚Üí·µí œà))
  ‚Üí‚ñ∑ {ùí´}{œï}{œà} ‚ñ∑œï‚Üí‚ñ∑œà n ùí´n j j<n i i‚â§j œïi =
    let ‚ñ∑œàsi = ‚ñ∑œï‚Üí‚ñ∑œà n ùí´n (suc i) (‚â§-trans‚Çö{suc i}{suc j}{n} i‚â§j j<n)
                Œª j j<si ‚Üí down œï tt·µñ tt‚Çö i œïi j j<si in
    down (‚ñ∑·µí œà) tt·µñ tt‚Çö (suc i) ‚ñ∑œàsi (suc i) (‚â§-refl‚Çö{i}) i (‚â§-refl‚Çö{suc i})

  ‚ñ∑‚àÄ : ‚àÄ{œï·µÉ : A ‚Üí Set·µè} ‚Üí ùí´ ‚ä¢·µí ‚ñ∑·µí (‚àÄ·µí œï·µÉ)  ‚Üí  ùí´ ‚ä¢·µí (‚àÄ·µí Œª a ‚Üí ‚ñ∑·µí (œï·µÉ a))
  ‚ñ∑‚àÄ ùí´‚ä¢‚ñ∑‚àÄœï·µÉ n ‚ä®ùí´sn a j j< = ùí´‚ä¢‚ñ∑‚àÄœï·µÉ n ‚ä®ùí´sn j j< a

record Inhabited (A : Set) : Set where
  field
    elt : A
open Inhabited {{...}} public

instance
  ‚Ñï-Inhabited : Inhabited ‚Ñï
  ‚Ñï-Inhabited = record { elt = zero }

abstract
  ‚ñ∑‚àÉ : ‚àÄ{œï·µÉ : A ‚Üí Set·µè}{{_ : Inhabited A}} ‚Üí ùí´ ‚ä¢·µí ‚ñ∑·µí (‚àÉ·µí œï·µÉ)  ‚Üí  ùí´ ‚ä¢·µí (‚àÉ·µí Œª a ‚Üí ‚ñ∑·µí (œï·µÉ a))
  ‚ñ∑‚àÉ ùí´‚ä¢‚ñ∑‚àÉœï·µÉ zero ‚ä®ùí´k = elt ,‚Çö (Œª j ())
  ‚ñ∑‚àÉ {œï·µÉ = œï·µÉ} ùí´‚ä¢‚ñ∑‚àÉœï·µÉ (suc k) ‚ä®ùí´sk 
      with ùí´‚ä¢‚ñ∑‚àÉœï·µÉ (suc k) ‚ä®ùí´sk k (‚â§-refl‚Çö{k})
  ... | a ,‚Çö œïk =
        a ,‚Çö Œª {j j‚â§k ‚Üí
             let œïj = down (œï·µÉ a) tt·µñ tt‚Çö k œïk j j‚â§k in
             down (œï·µÉ a) tt·µñ tt‚Çö j œïj j (‚â§-refl‚Çö{j})}

  ‚ñ∑pure·µí : [] ‚ä¢·µí ‚ñ∑·µí (p ·µí) ‚Üí [] ‚ä¢·µí p ·µí
  ‚ñ∑pure·µí ‚ä¢‚ñ∑ k tt·µñ = ‚ä¢‚ñ∑ (suc k) (squash tt) k (s‚â§s‚Çö{k} (‚â§-refl‚Çö{k})) 

‚ñ∑‚Üí‚ñ∑ : ùí´ ‚ä¢·µí ‚ñ∑·µí œï  ‚Üí  œï ‚à∑ ùí´ ‚ä¢·µí œà  ‚Üí  ùí´ ‚ä¢·µí ‚ñ∑·µí œà
‚ñ∑‚Üí‚ñ∑ ‚ñ∑P P‚ä¢Q = ‚Üí·µíE (‚ñ∑‚Üí (mono·µí (‚Üí·µíI P‚ä¢Q))) ‚ñ∑P

‚àÄ·µí-syntax : ‚àÄ{Œì}{Œî : Times Œì}{A : Set} ‚Üí (A ‚Üí Set·µí Œì Œî) ‚Üí Set·µí Œì Œî
‚àÄ·µí-syntax = ‚àÄ·µí
infix 1 ‚àÄ·µí-syntax
syntax ‚àÄ·µí-syntax (Œª x ‚Üí P) = ‚àÄ·µí[ x ] P

‚àÄ·µí-annot-syntax : ‚àÄ{Œì}{Œî : Times Œì} ‚Üí ‚àÄ (A : Set) ‚Üí (A ‚Üí Set·µí Œì Œî) ‚Üí Set·µí Œì Œî
‚àÄ·µí-annot-syntax A = ‚àÄ·µí {A = A}
infix 2 ‚àÄ·µí-annot-syntax
syntax ‚àÄ·µí-annot-syntax A (Œª x ‚Üí P) = ‚àÄ·µí[ x ‚¶Ç A ] P

‚àÉ·µí-syntax : ‚àÄ{Œì}{Œî : Times Œì}{A : Set} ‚Üí (A ‚Üí Set·µí Œì Œî) ‚Üí Set·µí Œì Œî
‚àÉ·µí-syntax = ‚àÉ·µí
infix 2 ‚àÉ·µí-syntax
syntax ‚àÉ·µí-syntax (Œª x ‚Üí P) = ‚àÉ·µí[ x ] P

{---------------------- Eventually Operator ---------------------}

‚óá·µí : ‚àÄ{Œì}{Œî : Times Œì}
   ‚Üí ‚Ñï
   ‚Üí Set·µí Œì Œî
     -----------------
   ‚Üí Set·µí Œì (laters Œì)
‚óá·µí {Œì} {Œî} zero œï = ‚ñ∑·µí œï
‚óá·µí {Œì} {Œî} (suc i) œï = ‚óá·µí i (‚ñ∑·µí œï)

‚ñ∑‚óá‚â°‚óá‚ñ∑ : ‚àÄ{œï : Set·µè} i ‚Üí ‚ñ∑·µí (‚óá·µí i œï) ‚â°·µí ‚óá·µí i (‚ñ∑·µí œï)
‚ñ∑‚óá‚â°‚óá‚ñ∑ {œï} zero = ‚â°·µí-refl refl
‚ñ∑‚óá‚â°‚óá‚ñ∑ {œï} (suc i) = ‚ñ∑‚óá‚â°‚óá‚ñ∑{‚ñ∑·µí œï} i 

abstract
  ‚ñ∑‚áí‚óá :  ùí´ ‚ä¢·µí ‚ñ∑·µí œï  ‚Üí  ùí´ ‚ä¢·µí ‚óá·µí 0 œï
  ‚ñ∑‚áí‚óá ‚ñ∑œï n ùí´n = ‚ñ∑œï n ùí´n
  
‚ñ∑‚óá‚áí‚óá : ‚àÄ i ‚Üí ùí´ ‚ä¢·µí ‚ñ∑·µí (‚óá·µí i œï) ‚Üí ùí´ ‚ä¢·µí ‚óá·µí (suc i) œï
‚ñ∑‚óá‚áí‚óá zero ‚ñ∑‚óáœï = ‚ñ∑‚óáœï
‚ñ∑‚óá‚áí‚óá {ùí´} (suc i) ‚ñ∑‚óáœï = ‚ñ∑‚óá‚áí‚óá {ùí´} i ‚ñ∑‚óáœï

‚ñ∑‚óá‚áí‚óá‚ñ∑ : ‚àÄ i ‚Üí ùí´ ‚ä¢·µí ‚ñ∑·µí (‚óá·µí i œï) ‚Üí ùí´ ‚ä¢·µí ‚óá·µí i (‚ñ∑·µí œï)
‚ñ∑‚óá‚áí‚óá‚ñ∑ {ùí´} i ‚ñ∑‚óáœï = ‚ñ∑‚óá‚áí‚óá{ùí´} i ‚ñ∑‚óáœï

‚óá‚ñ∑‚áí‚ñ∑‚óá : ‚àÄ i ‚Üí ùí´ ‚ä¢·µí ‚óá·µí i (‚ñ∑·µí œï) ‚Üí ùí´ ‚ä¢·µí ‚ñ∑·µí (‚óá·µí i œï)
‚óá‚ñ∑‚áí‚ñ∑‚óá {ùí´} zero ‚ñ∑‚ñ∑œï = ‚ñ∑‚ñ∑œï
‚óá‚ñ∑‚áí‚ñ∑‚óá {ùí´} (suc i) ‚óá‚ñ∑œï = ‚óá‚ñ∑‚áí‚ñ∑‚óá i ‚óá‚ñ∑œï

mono‚óá : ‚àÄ{k} ‚Üí ùí´ ‚ä¢·µí œï  ‚Üí  ùí´ ‚ä¢·µí ‚óá·µí k œï
mono‚óá {k = zero} œï = mono·µí œï
mono‚óá {k = suc k} œï =
  let ‚óákœï = mono‚óá {k = k} œï in
  let ‚ñ∑‚óákœï = mono·µí ‚óákœï in
  ‚ñ∑‚óá‚áí‚óá k ‚ñ∑‚óákœï

œï‚Üíœà‚áí‚óáœï‚Üí‚óáœà : ‚àÄ{k} ‚Üí ùí´ ‚ä¢·µí œï ‚Üí·µí œà ‚Üí ùí´ ‚ä¢·µí (‚óá·µí k œï) ‚Üí·µí (‚óá·µí k œà)
œï‚Üíœà‚áí‚óáœï‚Üí‚óáœà {k = zero} œï‚Üíœà = ‚ñ∑‚Üí (mono·µí œï‚Üíœà)
œï‚Üíœà‚áí‚óáœï‚Üí‚óáœà {k = suc k} œï‚Üíœà =
  let ‚óákœï‚Üí‚óákœà = œï‚Üíœà‚áí‚óáœï‚Üí‚óáœà {k = k} œï‚Üíœà in
  let ‚ñ∑‚óákœï‚Üí‚ñ∑‚óákœà = ‚ñ∑‚Üí (mono·µí ‚óákœï‚Üí‚óákœà) in
  ‚Üí·µíI (‚ñ∑‚óá‚áí‚óá‚ñ∑ k (‚Üí·µíE (S·µí ‚ñ∑‚óákœï‚Üí‚ñ∑‚óákœà) (‚óá‚ñ∑‚áí‚ñ∑‚óá k Z·µí)))

‚óá‚Üí‚óá : ‚àÄ{ùí´}{P Q : Set·µè} (k : ‚Ñï)
   ‚Üí ùí´ ‚ä¢·µí ‚óá·µí k P
   ‚Üí P ‚à∑ ùí´ ‚ä¢·µí Q
     ------------
   ‚Üí ùí´ ‚ä¢·µí ‚óá·µí k Q
‚óá‚Üí‚óá {ùí´} {P} {Q} k ‚óáP P‚ä¢Q =
  let ‚óáP‚Üí‚óáQ = œï‚Üíœà‚áí‚óáœï‚Üí‚óáœà {k = k} (‚Üí·µíI P‚ä¢Q) in
  ‚Üí·µíE ‚óáP‚Üí‚óáQ ‚óáP

{-
abstract
  ‚ä¢‚àÉ·µíE : ‚àÄ{œï·µÉ : A ‚Üí Set·µè} ‚Üí [] ‚ä¢·µí ‚àÉ·µí[ a ] œï·µÉ a ‚Üí Œ£[ a ‚àà A ] ([] ‚ä¢·µí œï·µÉ a)
  ‚ä¢‚àÉ·µíE {œï·µÉ = œï·µÉ} ‚ä¢‚àÉa,œï·µÉ =
     let xx = ‚ä¢·µíE{[]}{‚àÉ·µí[ a ] œï·µÉ a} ‚ä¢‚àÉa,œï·µÉ 0 (squash tt) in
     match xx Œª a œïa ‚Üí
     a , (‚ä¢·µíI{[]}{œï·µÉ a} (Œª n _ ‚Üí
       (match (‚ä¢·µíE{[]}{‚àÉ·µí[ a ] œï·µÉ a} ‚ä¢‚àÉa,œï·µÉ n (squash tt)) Œª b c ‚Üí
       {!!})))
-}

_‚äÇ_ : List Set·µè ‚Üí List Set·µè ‚Üí Prop
ùí´ ‚äÇ [] = ‚ä§‚Çö
ùí´ ‚äÇ (œï ‚à∑ ùí´‚Ä≤) = (ùí´ ‚ä¢·µí œï) √ó‚Çö (ùí´ ‚äÇ ùí´‚Ä≤)

abstract

  ‚äÇE : ‚àÄ{ùí´ ùí´‚Ä≤ : List Set·µè}{n}
     ‚Üí ùí´‚Ä≤ ‚äÇ ùí´
     ‚Üí # (Œ†·µè ùí´‚Ä≤) tt·µñ n
     ‚Üí # (Œ†·µè ùí´) tt·µñ n
  ‚äÇE {[]} {ùí´‚Ä≤} {n} ùí´‚Ä≤‚äÇùí´ ùí´‚Ä≤n = squash tt
  ‚äÇE {œï ‚à∑ ùí´} {ùí´‚Ä≤} {n} (‚ä¢œï ,‚Çö ùí´‚Ä≤‚äÇùí´) ùí´‚Ä≤n = ‚ä¢œï n ùí´‚Ä≤n ,‚Çö (‚äÇE ùí´‚Ä≤‚äÇùí´ ùí´‚Ä≤n)

  weaken : ‚àÄ{ùí´ ùí´‚Ä≤ : List Set·µè}{œï}
     ‚Üí ùí´ ‚ä¢·µí œï
     ‚Üí ùí´‚Ä≤ ‚äÇ ùí´
     ‚Üí ùí´‚Ä≤ ‚ä¢·µí œï
  weaken {ùí´}{ùí´‚Ä≤}{œï} ‚ä¢œï ùí´‚Ä≤‚äÇùí´ n ùí´‚Ä≤n = ‚ä¢œï n (‚äÇE ùí´‚Ä≤‚äÇùí´ ùí´‚Ä≤n)

drop : ‚àÄ{ùí´ ùí´‚Ä≤ : List Set·µè}{œï}
   ‚Üí ùí´ ‚äÇ ùí´‚Ä≤
   ‚Üí (œï ‚à∑ ùí´) ‚äÇ ùí´‚Ä≤
drop {ùí´} {[]} {œï} ùí´‚äÇùí´‚Ä≤ = tt‚Çö
drop {ùí´} {œà ‚à∑ ùí´‚Ä≤} {œï} (ùí´‚ä¢œà ,‚Çö ùí´‚äÇùí´‚Ä≤) = S·µí{ùí´}{œà}{œï} ùí´‚ä¢œà ,‚Çö drop ùí´‚äÇùí´‚Ä≤

‚äÇ-refl : ‚àÄ{ùí´} ‚Üí ùí´ ‚äÇ ùí´
‚äÇ-refl {[]} = tt‚Çö
‚äÇ-refl {P ‚à∑ ùí´} = Z·µí ,‚Çö drop ‚äÇ-refl

abstract
  ‚ñ∑œï‚áíœï : [] ‚ä¢·µí ‚ñ∑·µí œï ‚Üí [] ‚ä¢·µí œï
  ‚ñ∑œï‚áíœï ‚ñ∑œï n (squash tt) = ‚ñ∑œï (suc n) (squash tt) n (‚â§-refl‚Çö{n})

‚óáœï‚áíœï : ‚àÄ k ‚Üí [] ‚ä¢·µí ‚óá·µí k œï ‚Üí [] ‚ä¢·µí œï
‚óáœï‚áíœï zero ‚ñ∑œï = ‚ñ∑œï‚áíœï ‚ñ∑œï
‚óáœï‚áíœï (suc k) ‚óák‚ñ∑œï =
  let ‚óákœï = ‚ñ∑œï‚áíœï (‚óá‚ñ∑‚áí‚ñ∑‚óá k ‚óák‚ñ∑œï) in
  ‚óáœï‚áíœï k ‚óákœï
\end{code}
